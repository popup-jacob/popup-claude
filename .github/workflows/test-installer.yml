name: Test Installer

on:
  workflow_dispatch:
    inputs:
      os:
        description: 'Test OS'
        type: choice
        options:
          - all
          - windows
          - macos
        default: 'all'
      module:
        description: 'Module to test'
        type: choice
        options:
          - base
          - github
          - notion
          - figma
        default: 'base'

env:
  TERM: xterm
  CI: true

jobs:
  test-windows:
    if: ${{ github.event.inputs.os == 'all' || github.event.inputs.os == 'windows' }}
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run installer (base module)
        shell: pwsh
        run: |
          # CI에서 Clear-Host 실패 방지
          function Clear-Host {}
          # Claude native install PATH 추가
          $env:PATH = "$env:USERPROFILE\.local\bin;$env:PATH"
          Write-Host "Testing Windows installer..."
          $env:MODULES = '${{ github.event.inputs.module }}'
          & ./installer/install.ps1 -modules '${{ github.event.inputs.module }}'

      - name: Verify installation
        shell: pwsh
        run: |
          Write-Host "Checking installed tools..."

          # Check Node.js
          if (Get-Command node -ErrorAction SilentlyContinue) {
            Write-Host "OK Node.js: $(node --version)"
          } else {
            Write-Host "FAIL Node.js not found"
          }

          # Check Git
          if (Get-Command git -ErrorAction SilentlyContinue) {
            Write-Host "OK Git: $(git --version)"
          } else {
            Write-Host "FAIL Git not found"
          }

          # Check Claude
          if (Get-Command claude -ErrorAction SilentlyContinue) {
            Write-Host "OK Claude: $(claude --version)"
          } else {
            Write-Host "WARN Claude not in PATH (may need terminal restart)"
          }

  test-macos:
    if: ${{ github.event.inputs.os == 'all' || github.event.inputs.os == 'macos' }}
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run installer (base module)
        run: |
          echo "Testing macOS installer..."
          chmod +x ./installer/install.sh
          MODULES='${{ github.event.inputs.module }}' bash ./installer/install.sh

      - name: Verify installation
        run: |
          echo "Checking installed tools..."

          if command -v node &> /dev/null; then
            echo "OK Node.js: $(node --version)"
          else
            echo "FAIL Node.js not found"
          fi

          if command -v git &> /dev/null; then
            echo "OK Git: $(git --version)"
          else
            echo "FAIL Git not found"
          fi

          if command -v claude &> /dev/null; then
            echo "OK Claude: $(claude --version)"
          else
            echo "WARN Claude not in PATH (may need terminal restart)"
          fi

